<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gestion des employés</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

    <style>
        body { background: linear-gradient(135deg,#6a11cb,#2575fc); min-height: 100vh; color: white; padding-top: 30px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .card { border-radius: 14px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .btn-wide { padding: 10px 20px; border-radius: 20px; }
        .btn-sm-wide { padding: 6px 14px; border-radius: 10px; }
        input.form-control-inline, select.form-control-inline { width: 100%; padding: 2px 6px; font-size: 0.9rem; }
        .action-buttons { display: flex; gap: 6px; align-items: center; }

        /* NOUVEAU : panneau PDF */
        .pdf-panel {
            background: #f8f9fa;
            color: black;
            padding: 15px;
            border-radius: 10px;
            margin-top: 8px;
            display: none;
        }
        .pdf-row {
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>

<body>
<div class="container">
    <div class="top-bar">
        <h2>Espace RH — Employés</h2>
        <div>
            <button id="addEmployeeBtn" class="btn btn-light btn-wide text-dark mr-2">+ Nouvel employé</button>
            <a href="/" class="btn btn-danger btn-wide">Déconnexion</a>
        </div>
    </div>

    <div class="card bg-light text-dark p-3">
        <table class="table table-striped">
            <thead class="thead-light">
            <tr>
                <th>#</th><th>Nom</th><th>Prénom</th><th>Email</th>
                <th>Poste</th><th>Heures</th><th>Salaire</th>
                <th>MDP</th><th>Abilités</th><th>Actions</th>
            </tr>
            </thead>

            <tbody id="employeeTableBody">

            <!-- EMPLOYÉS -->
            <tr th:each="emp : ${employees}" th:id="'row-' + ${emp.id}">
                <td th:text="${emp.id}" class="emp-id"></td>
                <td th:text="${emp.lastName}" class="emp-lastName"></td>
                <td th:text="${emp.firstName}" class="emp-firstName"></td>
                <td th:text="${emp.email}" class="emp-email"></td>
                <td th:text="${emp.job}" class="emp-job"></td>
                <td th:text="${emp.hours}" class="emp-hours"></td>
                <td th:text="${emp.salary}" class="emp-salary"></td>

                <!-- Mot de passe masqué -->
                <td class="emp-mdp">
                    ••••••
                    <span class="real-mdp" th:text="${emp.mdp}" style="display:none;"></span>
                </td>

                <td th:text="${emp.abilities}" class="emp-abilities"></td>

                <td class="action-buttons">
                    <!-- NOUVEAU : Bouton Voir les PDFs -->
                    <button class="btn btn-primary btn-sm-wide"
                            onclick="togglePayslips(this)"
                            th:data-id="${emp.id}">
                        Voir PDF
                    </button>

                    <button class="btn btn-warning btn-sm-wide" onclick="enableEdit(this)">Modifier</button>
                    <button class="btn btn-danger btn-sm-wide" onclick="deleteEmployee(this)">Supprimer</button>
                </td>
            </tr>

            <!-- Si aucun employé -->
            <tr th:if="${#lists.isEmpty(employees)}">
                <td colspan="10" class="text-center">Aucun employé</td>
            </tr>

            </tbody>
        </table>
    </div>
</div>

<script>
    /* ========================================================= */
    /* ============== AFFICHAGE DES FICHES DE PAIE ============= */
    /* ========================================================= */
    function togglePayslips(button) {
        const id = button.dataset.id;

        let existing = document.getElementById("pdf-panel-" + id);

        // Si existe déjà → simple toggle
        if (existing) {
            existing.style.display = existing.style.display === "none" ? "block" : "none";
            return;
        }

        // Sinon → appel API et affichage
        fetch("http://localhost:8080/api/payslips/employee/" + id)
            .then(res => res.json())
            .then(list => {
                const row = button.closest("tr");

                const container = document.createElement("tr");
                container.innerHTML = `
                    <td colspan="10">
                        <div class="pdf-panel" id="pdf-panel-${id}">
                            <h5>Fiches de paie :</h5>
                            <div id="pdf-list-${id}"></div>
                        </div>
                    </td>`;
                row.after(container);

                const listDiv = document.getElementById("pdf-list-" + id);

                if (list.length === 0) {
                    listDiv.innerHTML = "<p>Aucun PDF trouvé.</p>";
                    return;
                }

                list.forEach(p => {
                    listDiv.innerHTML += `
                        <div class="pdf-row">
                            <strong>${p.month}</strong>
                            <div>
                                <a class="btn btn-info btn-sm-wide" href="${p.urlPdf}" target="_blank">Voir</a>
                                <a class="btn btn-success btn-sm-wide" href="${p.urlPdf}" download>Télécharger</a>
                            </div>
                        </div>`;
                });

                document.getElementById("pdf-panel-" + id).style.display = "block";
            });
    }


    /* ========================================================= */
    /* === TON CODE EXISTANT (modifier/supprimer/ajouter) ======= */
    /* ========================================================= */

    function enableEdit(button) {
        const row = button.closest('tr');
        const id = row.querySelector('.emp-id').textContent.trim();

        row.querySelector(".action-buttons").querySelectorAll('button')[2].style.display = "none";

        const mdpReal = row.querySelector(".real-mdp").textContent.trim();

        const fields = ['lastName','firstName','email','job','hours','salary','abilities'];

        fields.forEach(field => {
            const td = row.querySelector(`.emp-${field}`);
            const value = td.textContent.trim();

            if (field === "abilities") {
                td.innerHTML = `
                    <select name="abilities" class="form-control-inline">
                        <option value="EMPLOYE" ${value === 'EMPLOYE' ? 'selected' : ''}>EMPLOYE</option>
                        <option value="RH" ${value === 'RH' ? 'selected' : ''}>RH</option>
                    </select>`;
            } else {
                td.innerHTML = `<input class="form-control-inline" name="${field}" value="${value}">`;
            }
        });

        const mdpTd = row.querySelector('.emp-mdp');
        mdpTd.innerHTML = `<input class="form-control-inline" name="mdp" value="${mdpReal}">`;

        const actions = row.querySelector('.action-buttons');
        const cancelBtn = document.createElement("button");
        cancelBtn.className = "btn btn-secondary btn-sm-wide";
        cancelBtn.textContent = "Annuler";
        cancelBtn.onclick = () => window.location.reload();
        actions.appendChild(cancelBtn);

        button.textContent = 'Valider';
        button.classList.replace('btn-warning','btn-success');
        button.onclick = () => validateEdit(id, row);
    }

    function validateEdit(id, row) {
        const inputs = row.querySelectorAll('input, select');

        const data = {
            lastName: inputs[0].value,
            firstName: inputs[1].value,
            email: inputs[2].value,
            job: inputs[3].value,
            hours: inputs[4].value,
            salary: inputs[5].value,
            mdp: inputs[6].value,
            abilities: inputs[7].value
        };

        fetch(`/employees/update/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => res.ok ? window.location.reload() : alert("Erreur mise à jour"))
            .catch(() => alert("Erreur réseau"));
    }

    function deleteEmployee(button) {
        const row = button.closest('tr');
        const id = row.querySelector('.emp-id').textContent.trim();
        if (!confirm('Confirmer la suppression ?')) return;

        fetch(`/employees/delete/${id}`, { method: 'DELETE' })
            .then(res => res.ok ? window.location.reload() : alert("Erreur suppression"))
            .catch(() => alert("Erreur réseau"));
    }

    document.getElementById('addEmployeeBtn').onclick = () => {
        if (document.getElementById('new-employee-row')) return;

        const table = document.getElementById('employeeTableBody');
        const row = document.createElement('tr');
        row.id = 'new-employee-row';

        row.innerHTML = `
            <td>—</td>
            <td><input name="lastName" class="form-control-inline"></td>
            <td><input name="firstName" class="form-control-inline"></td>
            <td><input name="email" class="form-control-inline"></td>
            <td><input name="job" class="form-control-inline"></td>
            <td><input name="hours" class="form-control-inline"></td>
            <td><input name="salary" class="form-control-inline"></td>
            <td><input name="mdp" class="form-control-inline"></td>
            <td>
                <select name="abilities" class="form-control-inline">
                    <option value="EMPLOYE">EMPLOYE</option>
                    <option value="RH">RH</option>
                </select>
            </td>
            <td class="action-buttons">
                <button class="btn btn-success btn-sm-wide" onclick="submitNewEmployee(this)">Ajouter</button>
                <button class="btn btn-secondary btn-sm-wide" onclick="cancelNewEmployee()">Annuler</button>
            </td>
        `;

        table.prepend(row);
    };

    function cancelNewEmployee() {
        const r = document.getElementById('new-employee-row');
        if (r) r.remove();
    }

    function submitNewEmployee(button) {
        const row = button.closest('tr');
        const inputs = row.querySelectorAll('input, select');

        const data = {
            lastName: inputs[0].value,
            firstName: inputs[1].value,
            email: inputs[2].value,
            job: inputs[3].value,
            hours: inputs[4].value,
            salary: inputs[5].value,
            mdp: inputs[6].value,
            abilities: inputs[7].value
        };

        fetch('/employees/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => res.ok ? window.location.reload() : alert("Erreur création"))
            .catch(() => alert("Erreur réseau"));
    }
</script>

</body>
</html>
