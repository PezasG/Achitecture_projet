<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Espace Employé — Tableau de bord</title>

    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

    <style>
        body {
            background: linear-gradient(135deg,#6a11cb,#2575fc);
            color: white;
            min-height: 100vh;
            padding-top: 50px;
        }

        .card {
            border-radius: 14px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            background: #fff;
            color: #333;
        }

        .btn-wide {
            padding: 10px 22px;
            border-radius: 24px;
        }

        .info-label { font-weight: bold; color: #444; }
        .info-value { color: #111; }
    </style>
</head>

<body>

<div class="container" style="max-width: 900px;">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4 text-white">
        <h2 id="employeeName" class="mb-0">Bonjour</h2>
        <a href="/" class="btn btn-danger btn-wide">Déconnexion</a>
    </div>

    <!-- CARD -->
    <div class="card p-4">

        <!-- ONGLET -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link active" data-toggle="tab" href="#infos">Informations</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#paie">Fiches de paie</a>
            </li>
        </ul>

        <div class="tab-content">

            <!-- INFO -->
            <div class="tab-pane fade show active" id="infos">
                <h4 class="mb-3">Vos informations personnelles</h4>

                <div class="row">
                    <div class="col-md-6 mb-2"><span class="info-label">Nom :</span> <span id="info-lastName"></span></div>
                    <div class="col-md-6 mb-2"><span class="info-label">Prénom :</span> <span id="info-firstName"></span></div>
                    <div class="col-md-6 mb-2"><span class="info-label">Email :</span> <span id="info-email"></span></div>
                    <div class="col-md-6 mb-2"><span class="info-label">Poste :</span> <span id="info-job"></span></div>
                    <div class="col-md-6 mb-2"><span class="info-label">Heures :</span> <span id="info-hours"></span></div>
                    <div class="col-md-6 mb-2"><span class="info-label">Salaire :</span> <span id="info-salary"></span></div>
                    <div class="col-md-6 mb-2"><span class="info-label">Mot de passe :</span> <span id="info-mdp"></span></div>
                    <div class="col-md-6 mb-2"><span class="info-label">Rôle :</span> <span id="info-role"></span></div>
                </div>
            </div>

            <!-- FICHES DE PAIE -->
            <div class="tab-pane fade" id="paie">
                <h4 class="mb-3">Vos fiches de paie</h4>

                <table class="table table-hover">
                    <thead class="thead-light">
                    <tr>
                        <th>Mois</th>
                        <th>Salaire Net</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="list_of_pdf"></tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<!-- LIBS -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

<script>

    /* ---------------------- CHARGEMENT COMPLET DU DASHBOARD ---------------------- */
    async function loadEmployeeDashboard() {

        const stored = localStorage.getItem("employee");

        if (!stored) {
            alert("Aucun utilisateur connecté");
            window.location.href = "/";
            return;
        }

        const emp = JSON.parse(stored);
        const id = emp.id;

        /* ---------- RÉCUPÉRER LES INFORMATIONS DE L'EMPLOYÉ ---------- */
        const res = await fetch(`http://localhost:8080/api/employees/get/${id}`);
        const employee = await res.json();

        document.getElementById("employeeName").innerText = "Bonjour, " + employee.firstName;

        document.getElementById("info-lastName").innerText = employee.lastName;
        document.getElementById("info-firstName").innerText = employee.firstName;
        document.getElementById("info-email").innerText = employee.email;
        document.getElementById("info-job").innerText = employee.job;
        document.getElementById("info-hours").innerText = employee.hours;
        document.getElementById("info-salary").innerText = employee.salary + " €";
        document.getElementById("info-mdp").innerText = employee.mdp;
        document.getElementById("info-role").innerText = employee.abilities;

        /* ---------- CHARGER LES FICHES DE PAIE ---------- */
        loadPayslips(id);
    }

    /* ---------------------- FICHES DE PAIE ---------------------- */
    async function loadPayslips(id) {

        const tbody = document.getElementById("list_of_pdf");
        tbody.innerHTML = "";

        const res = await fetch(`http://localhost:8080/api/payslips/employee/${id}`);
        const payslips = await res.json();

        if (!payslips || payslips.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-muted">
                        Aucune fiche de paie trouvée
                    </td>
                </tr>`;
            return;
        }

        payslips.forEach(p => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${p.month}</td>
                <td>${p.netSalary} €</td>
                <td>
                    <a href="http://localhost:8080/api/payslips/download/${p.id}" target="_blank" class="btn btn-primary">Voir | ⬇ Télécharger</a>
                </td>
            `;
            tbody.appendChild(tr);
        });

    }
    loadEmployeeDashboard();

</script>

</body>
</html>
