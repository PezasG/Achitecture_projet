<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>RH — Gestion des employés</title>

    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

    <style>
        body {
            background: linear-gradient(135deg,#6a11cb,#2575fc);
            min-height: 100vh;
            color: white;
            padding-top: 30px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .card {
            border-radius: 14px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn-wide {
            padding: 10px 20px;
            border-radius: 20px;
        }

        .btn-sm-wide {
            padding: 6px 14px;
            border-radius: 10px;
        }

        input.form-control-inline {
            width: 100%;
            padding: 2px 6px;
            font-size: 0.9rem;
        }

        h2 {
            font-weight: 600;
        }
    </style>
</head>

<body>

<div class="container">

    <!-- BARRE SUPERIEURE -->
    <div class="top-bar">
        <h2>Espace RH — Employés</h2>

        <div>
            <button id="addEmployeeBtn" class="btn btn-light btn-wide text-dark mr-2">
                + Nouvel employé
            </button>

            <!-- BOUTON DECONNEXION -->
            <a href="/" class="btn btn-danger btn-wide">
                Déconnexion
            </a>
        </div>
    </div>

    <!-- LISTE DES EMPLOYES -->
    <div class="card bg-light text-dark p-3">
        <table class="table table-striped">
            <thead class="thead-light">
            <tr>
                <th>#</th>
                <th>Nom</th>
                <th>Prénom</th>
                <th>Email</th>
                <th>Poste</th>
                <th>Heures</th>
                <th>Salaire</th>
                <th>Mot de passe</th>
                <th>Actions</th>
            </tr>
            </thead>

            <tbody id="employeeTableBody">

            <tr th:each="emp : ${employees}" th:object="${emp}" th:id="'row-' + ${emp.id}">
                <td th:text="${emp.id}" class="emp-id">1</td>
                <td class="emp-lastName" th:text="${emp.lastName}">Dupont</td>
                <td class="emp-firstName" th:text="${emp.firstName}">Paul</td>
                <td class="emp-email" th:text="${emp.email}">p.dupont@example.com</td>
                <td class="emp-jobTitle" th:text="${emp.jobTitle}">Développeur</td>
                <td class="emp-hours" th:text="${emp.hours}">35</td>
                <td class="emp-salary" th:text="${emp.salary}">2500</td>
                <td class="emp-password" th:text="${emp.password != null ? '••••••' : ''}">
                    ••••••
                </td>

                <td>
                    <button class="btn btn-sm btn-warning btn-sm-wide"
                            onclick="enableEdit(this)">
                        Modifier
                    </button>

                    <form th:action="@{|/employees/delete/${emp.id}|}"
                          method="post"
                          th:onsubmit="return confirm('Supprimer cet employé ?');"
                          style="display:inline-block;">
                        <button type="submit" class="btn btn-sm btn-danger btn-sm-wide">
                            Supprimer
                        </button>
                    </form>
                </td>
            </tr>

            <tr th:if="${#lists.isEmpty(employees)}">
                <td colspan="9" class="text-center">Aucun employé</td>
            </tr>

            </tbody>
        </table>
    </div>
</div>

<!-- JS INCHANGÉ -->
<script>
    function enableEdit(button) {
        const row = button.closest('tr');
        const id = row.querySelector('.emp-id').textContent.trim();

        const editableFields = [
            'lastName', 'firstName', 'email', 'jobTitle', 'hours', 'salary', 'password'
        ];

        editableFields.forEach(field => {
            const td = row.querySelector(`.emp-${field}`);
            const value = td.textContent.trim();
            td.innerHTML =
                `<input name="${field}" type="text" class="form-control-inline" value="${value === '••••••' ? '' : value}">`;
        });

        button.textContent = "Valider";
        button.classList.remove("btn-warning");
        button.classList.add("btn-success");
        button.onclick = function () {
            validateEdit(this, id);
        };
    }

    function validateEdit(button, id) {
        const row = button.closest('tr');
        const inputs = row.querySelectorAll('input');

        const data = {
            id: id,
            lastName: inputs[0].value,
            firstName: inputs[1].value,
            email: inputs[2].value,
            jobTitle: inputs[3].value,
            hours: inputs[4].value,
            salary: inputs[5].value,
            password: inputs[6].value
        };

        fetch(`/employees/update/${id}`, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(res => {
            if (res.ok) {
                row.querySelector('.emp-lastName').textContent = data.lastName;
                row.querySelector('.emp-firstName').textContent = data.firstName;
                row.querySelector('.emp-email').textContent = data.email;
                row.querySelector('.emp-jobTitle').textContent = data.jobTitle;
                row.querySelector('.emp-hours').textContent = data.hours;
                row.querySelector('.emp-salary').textContent = data.salary;
                row.querySelector('.emp-password').textContent = '••••••';

                button.textContent = "Modifier";
                button.classList.remove("btn-success");
                button.classList.add("btn-warning");
                button.onclick = function () {
                    enableEdit(this);
                };
            } else {
                alert("Erreur lors de la mise à jour.");
            }
        }).catch(err => {
            console.error(err);
            alert("Erreur réseau");
        });
    }

    document.getElementById("addEmployeeBtn").addEventListener("click", function () {
        const tableBody = document.getElementById("employeeTableBody");
        if (document.getElementById("new-employee-row")) return;

        const row = document.createElement("tr");
        row.id = "new-employee-row";
        row.innerHTML = `
      <td>—</td>
      <td><input name="lastName" class="form-control-inline" placeholder="Nom"></td>
      <td><input name="firstName" class="form-control-inline" placeholder="Prénom"></td>
      <td><input name="email" class="form-control-inline" placeholder="Email"></td>
      <td><input name="jobTitle" class="form-control-inline" placeholder="Poste"></td>
      <td><input name="hours" class="form-control-inline" placeholder="Heures"></td>
      <td><input name="salary" class="form-control-inline" placeholder="Salaire"></td>
      <td><input name="password" class="form-control-inline" placeholder="Mot de passe"></td>
      <td>
        <button class="btn btn-success btn-sm-wide" onclick="submitNewEmployee(this)">Ajouter</button>
        <button class="btn btn-secondary btn-sm-wide" onclick="cancelNewEmployee()">Annuler</button>
      </td>
    `;
        tableBody.prepend(row);
    });

    function cancelNewEmployee() {
        const row = document.getElementById("new-employee-row");
        if (row) row.remove();
    }

    function submitNewEmployee(button) {
        const row = button.closest('tr');
        const inputs = row.querySelectorAll('input');

        const data = {
            lastName: inputs[0].value,
            firstName: inputs[1].value,
            email: inputs[2].value,
            jobTitle: inputs[3].value,
            hours: inputs[4].value,
            salary: inputs[5].value,
            password: inputs[6].value
        };

        fetch('/employees/create', {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(res => {
            if (res.ok) {
                res.json().then(createdEmployee => {
                    const tableBody = document.getElementById("employeeTableBody");
                    const newRow = document.createElement("tr");
                    newRow.innerHTML = `
            <td>${createdEmployee.id}</td>
            <td class="emp-lastName">${createdEmployee.lastName}</td>
            <td class="emp-firstName">${createdEmployee.firstName}</td>
            <td class="emp-email">${createdEmployee.email}</td>
            <td class="emp-jobTitle">${createdEmployee.jobTitle}</td>
            <td class="emp-hours">${createdEmployee.hours}</td>
            <td class="emp-salary">${createdEmployee.salary}</td>
            <td class="emp-password">••••••</td>
            <td>
              <button class="btn btn-sm btn-warning btn-sm-wide" onclick="enableEdit(this)">Modifier</button>
              <form action="/employees/delete/${createdEmployee.id}" method="post" onsubmit="return confirm('Supprimer cet employé ?');" style="display:inline-block;">
                <button type="submit" class="btn btn-sm btn-danger btn-sm-wide">Supprimer</button>
              </form>
            </td>
          `;
                    tableBody.appendChild(newRow);
                    row.remove();
                });
            } else {
                alert("Erreur lors de la création.");
            }
        }).catch(err => {
            console.error(err);
            alert("Erreur réseau");
        });
    }
</script>

</body>
</html>
